<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Dev Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.min.js"></script>

    <style id="dynamic-styles"></style>

    <style>
        body {
            font-family: 'Helvetica Neue', sans-serif;
            padding: 20px;
            background: #f4f4f4;
        }

        h1 {
            text-align: center;
            color: #333;
        }

        .controls-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .button-group {
            display: flex;
            gap: 5px;
        }

        .button,
        select {
            padding: 8px 12px;
            border: 1px solid #ccc;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }

        .button.active,
        .button:hover {
            background: #333;
            color: white;
            border-color: #333;
        }

        /* Edit Mode Styles */
        .btn-add {
            background: #27ae60;
            color: white;
            border-color: #219150;
            font-weight: bold;
        }

        .btn-add:hover {
            background: #219150;
        }

        /* Hide add button when read-only */
        .hidden {
            display: none !important;
        }

        .btn-lock {
            background: #e74c3c;
            color: white;
            font-weight: bold;
            border: none;
        }

        .btn-unlock {
            background: #f39c12;
            color: white;
            font-weight: bold;
            border: none;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 8px;
            width: 400px; /* Widened for better form layout */
            max-height: 90vh; /* Prevent overflow on small screens */
            overflow-y: auto;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        /* Form Inputs */
        .modal-content label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
            font-size: 12px;
            color: #555;
        }

        .modal-content input, 
        .modal-content select, 
        .modal-content textarea {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-family: inherit;
        }

        .modal-actions {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-save {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }

        .type-default .bar {
            fill: #95a5a6 !important;
        }

        .popup-wrapper {
            background: #fff !important;
            color: #333 !important;
            width: 320px !important;
            padding: 0 !important;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4) !important;
            border-radius: 5px !important;
            z-index: 9999 !important;
        }

        .popup-wrapper::after {
            border-bottom-color: #fff !important;
        }

        .details-container {
            font-size: 13px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .details-container h5 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 16px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }

        .details-container label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
            font-size: 11px;
            color: #7f8c8d;
            text-transform: uppercase;
        }

        .details-container select,
        .details-container textarea,
        .details-container input {
            width: 100%;
            padding: 8px;
            margin-top: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            font-size: 12px;
            box-sizing: border-box;
            background: #fafafa;
        }

        .details-container select[multiple] {
            height: 80px;
            background: #fff;
        }

        /* Visually show disabled inputs */
        .details-container *:disabled {
            background: #eee;
            color: #999;
            cursor: not-allowed;
        }

        .gantt-container {
            background: white;
            border-radius: 8px;
            overflow: visible !important;
        }

        svg#gantt {
            overflow: visible !important;
        }

        .body-wrapper {
            min-height: 900px;
            padding-bottom: 100px;
        }
        
        /* Helper for side-by-side inputs in modal */
        .flex-row {
            display: flex; gap: 10px;
        }
        .flex-col {
            flex: 1;
        }
    </style>
</head>

<body>

    <div class="body-wrapper">
        <h1>Software Development Tracker</h1>

        <div class="controls-wrapper">
            <div style="display:flex; gap:10px; align-items:center;">
                <button id="auth-btn" class="button btn-unlock" onclick="toggleEditMode()">ðŸ”’ Unlock Editing</button>

                <button id="add-btn" class="button btn-add hidden" onclick="openAddModal()">+ New Task</button>

                <select id="assignee-filter" onchange="redrawChart()">
                    <option value="All">All Developers</option>
                </select>

                <select id="type-filter" onchange="redrawChart()">
                    <option value="All">All Types</option>
                </select>
            </div>

            <div class="button-group">
                <button class="button" onclick="changeView('Quarter Day', this)">Quarter Day</button>
                <button class="button" onclick="changeView('Half Day', this)">Half Day</button>
                <button class="button" onclick="changeView('Day', this)">Day</button>
                <button class="button active" onclick="changeView('Week', this)">Week</button>
                <button class="button" onclick="changeView('Month', this)">Month</button>
            </div>
        </div>

        <svg id="gantt"></svg>
    </div>

    <div id="add-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Add New Task</h3>
            
            <label>ID (Optional)</label>
            <input type="number" id="new-id" placeholder="Auto-generated if empty">

            <label>Task Name *</label> 
            <input type="text" id="new-name" placeholder="e.g. Design Database">
            
            <div class="flex-row">
                <div class="flex-col">
                    <label>Start Date *</label> 
                    <input type="date" id="new-start">
                </div>
                <div class="flex-col">
                    <label>End Date *</label> 
                    <input type="date" id="new-end">
                </div>
            </div>

            <div class="flex-row">
                <div class="flex-col">
                    <label>Type</label> 
                    <select id="new-type"></select>
                </div>
                <div class="flex-col">
                    <label>Assignee</label> 
                    <select id="new-assignee"></select>
                </div>
            </div>

            <label>Progress (%)</label> 
            <input type="number" id="new-progress" min="0" max="100" value="0">

            <label>Task URL</label> 
            <input type="text" id="new-url" placeholder="https://...">

            <label>Description</label> 
            <textarea id="new-desc" rows="3"></textarea>

            <div class="modal-actions">
                <button class="button" onclick="closeAddModal()">Cancel</button>
                <button class="btn-save" onclick="saveNewTask()">Create</button>
            </div>
        </div>
    </div>

    <div id="password-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Admin Login</h3>
            <label>Enter Password:</label>
            <input type="password" id="admin-pass" onkeyup="if(event.key==='Enter') verifyPassword()">
            <div class="modal-actions">
                <button class="button" onclick="closePassModal()">Cancel</button>
                <button class="btn-save" onclick="verifyPassword()">Unlock</button>
            </div>
        </div>
    </div>

    <script>
        let gantt;
        let allTasks = [];
        let developers = [];
        let taskTypes = [];
        let isEditMode = false; // DEFAULT IS READ ONLY

        window.onload = async function () {
            try {
                const [tasksRes, devsRes, typesRes] = await Promise.all([
                    fetch('/api/tasks'),
                    fetch('/api/assignees'),
                    fetch('/api/task-types')
                ]);
                allTasks = await tasksRes.json();
                developers = await devsRes.json();
                taskTypes = await typesRes.json();

                generateTypeStyles();
                populateDropdowns();
                redrawChart();
            } catch (err) {
                console.error(err);
            }
        };

        // --- AUTHENTICATION LOGIC ---
        function toggleEditMode() {
            if (isEditMode) {
                // Lock it
                isEditMode = false;
                updateAuthUI();
                redrawChart(); // Re-render to disable dragging
            } else {
                // Open password modal
                document.getElementById('password-modal').style.display = 'flex';
                document.getElementById('admin-pass').value = '';
                document.getElementById('admin-pass').focus();
            }
        }

        function verifyPassword() {
            const pass = document.getElementById('admin-pass').value;
            fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: pass })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        isEditMode = true;
                        closePassModal();
                        updateAuthUI();
                        redrawChart(); // Re-render to enable dragging
                    } else {
                        alert("Incorrect Password");
                    }
                });
        }

        function updateAuthUI() {
            const btn = document.getElementById('auth-btn');
            const addBtn = document.getElementById('add-btn');

            if (isEditMode) {
                btn.innerHTML = "ðŸ”“ Lock Editing";
                btn.className = "button btn-lock";
                addBtn.classList.remove('hidden');
            } else {
                btn.innerHTML = "ðŸ”’ Unlock Editing";
                btn.className = "button btn-unlock";
                addBtn.classList.add('hidden');
            }
        }

        function closePassModal() { document.getElementById('password-modal').style.display = 'none'; }
        
        // --- ADD MODAL LOGIC (UPDATED) ---
        function openAddModal() { 
            // Populate Types
            const typeSelect = document.getElementById('new-type');
            typeSelect.innerHTML = '';
            taskTypes.forEach(t => {
                let opt = document.createElement('option');
                opt.value = t.name;
                opt.text = t.name;
                typeSelect.appendChild(opt);
            });

            // Populate Assignees
            const assignSelect = document.getElementById('new-assignee');
            assignSelect.innerHTML = '';
            developers.forEach(d => {
                let opt = document.createElement('option');
                opt.value = d;
                opt.text = d;
                assignSelect.appendChild(opt);
            });

            document.getElementById('add-modal').style.display = 'flex'; 
        }

        function closeAddModal() { document.getElementById('add-modal').style.display = 'none'; }

        // --- CHART LOGIC ---
        function generateTypeStyles() {
            let styleHTML = "";
            
            taskTypes.forEach(type => {
                const safeName = "type-" + type.name.toLowerCase().replace(/\s+/g, '-');
                
                // 1. The Bold Color (for Progress and Border)
                const boldColor = type.color;
                
                // 2. The Washed-out Color (for the empty part of the bar)
                const paleColor = lightenDarkenColor(boldColor, 50);

                styleHTML += `
                    .${safeName} .bar { 
                        fill: ${paleColor} !important; 
                        stroke: ${boldColor} !important;
                        stroke-width: 1px !important;
                    }
                    .${safeName} .bar-progress { 
                        fill: ${boldColor} !important; 
                    }
                `;
            });
            
            document.getElementById('dynamic-styles').innerHTML = styleHTML;
        }

        function populateDropdowns() {
            // 1. Assignee Filter
            const filterSelect = document.getElementById('assignee-filter');
            filterSelect.innerHTML = '<option value="All">All Developers</option>';
            developers.forEach(dev => {
                const option = document.createElement("option");
                option.value = dev;
                option.text = dev;
                filterSelect.appendChild(option);
            });

            // 2. Task Type Filter
            const typeSelect = document.getElementById('type-filter');
            typeSelect.innerHTML = '<option value="All">All Types</option>';
            taskTypes.forEach(type => {
                const option = document.createElement("option");
                option.value = type.name;
                option.text = type.name;
                typeSelect.appendChild(option);
            });
        }

        function redrawChart() {
            const selectedDev = document.getElementById('assignee-filter').value;
            const selectedType = document.getElementById('type-filter').value; // Get Type Filter
            
            // 1. Filter the tasks (Check BOTH filters)
            let filteredRaw = allTasks;

            if (selectedDev !== "All") {
                filteredRaw = filteredRaw.filter(t => t.assignee === selectedDev);
            }

            if (selectedType !== "All") {
                filteredRaw = filteredRaw.filter(t => t.task_type === selectedType);
            }
            
            // 2. SAFETY CHECK: Create a Set of all IDs currently visible
            const visibleIds = new Set(filteredRaw.map(t => String(t.id)));

            const ganttData = filteredRaw.map(t => formatTaskForGantt(t, visibleIds));

            document.getElementById('gantt').innerHTML = '';
            initGantt(ganttData);
        }

        function formatTaskForGantt(t, visibleIds) {
            let cssClass = 'type-default';
            if (t.task_type) {
                cssClass = "type-" + t.task_type.toLowerCase().replace(/\s+/g, '-');
            }

            // 1. Process Dependencies
            let depsArray = t.dependencies ? String(t.dependencies).split(',') : [];
            
            // If visibleIds is provided (we are filtering), remove deps that aren't on screen
            if (visibleIds) {
                depsArray = depsArray.filter(d => visibleIds.has(d.trim()));
            }

            // 2. FIX: Prevent Double Prefixing (task-task-1)
            let fixedDeps = depsArray.map(d => {
                const cleanD = d.trim();
                return cleanD.startsWith("task-") ? cleanD : "task-" + cleanD;
            }).join(', ');

            // 3. FIX: Prevent Double Prefixing on ID
            const rawIdString = String(t.id);
            const finalId = rawIdString.startsWith("task-") ? rawIdString : "task-" + rawIdString;

            return { 
                ...t, 
                id: finalId, 
                dependencies: fixedDeps, 
                _originalId: t.id, // Keep the raw ID (e.g. 1) safe here
                custom_class: cssClass 
            };
        }

        function initGantt(tasksToRender) {
            if (tasksToRender.length === 0) return;

            gantt = new Gantt("#gantt", tasksToRender, {
                header_height: 50, column_width: 30, step: 24,
                view_modes: ['Quarter Day', 'Half Day', 'Day', 'Week', 'Month'],
                bar_height: 25, bar_corner_radius: 3, arrow_curve: 5, padding: 18,
                view_mode: 'Week', date_format: 'YYYY-MM-DD', language: 'en',

                // *** READ ONLY TOGGLE ***
                readonly: !isEditMode,

                on_date_change: function (task, start, end) {
                    if (!isEditMode) return;
                    const newStart = start.toISOString().split('T')[0];
                    const newEnd = end.toISOString().split('T')[0];
                    updateServer({ id: task._originalId, start: newStart, end: newEnd });
                },

                on_progress_change: function (task, progress) {
                    if (!isEditMode) return;
                    updateServer({ id: task._originalId, progress: progress });
                },

                custom_popup_html: function (task) {
                    const rawTask = allTasks.find(t => t.id == task._originalId) || task;

                    // DISABLE INPUTS IF READ ONLY
                    const disabledAttr = isEditMode ? "" : "disabled";

                    // Only show link HTML if URL exists
                    const linkHtml = rawTask.task_url ? `<a href="${rawTask.task_url}" target="_blank" style="float:right; font-size:11px; margin-top:3px;">ðŸ”— Open</a>` : '';

                    // Generate Dropdowns
                    let devOptions = developers.map(dev => `<option value="${dev}" ${rawTask.assignee === dev ? 'selected' : ''}>${dev}</option>`).join('');
                    let typeOptions = taskTypes.map(type => `<option value="${type.name}" ${rawTask.task_type === type.name ? 'selected' : ''}>${type.name}</option>`).join('');

                    let currentDeps = rawTask.dependencies ? String(rawTask.dependencies).split(',').map(d => d.trim()) : [];
                    let depOptions = allTasks.filter(t => t.id != rawTask.id).map(t => {
                        const isSelected = currentDeps.includes(String(t.id)) ? 'selected' : '';
                        return `<option value="${t.id}" ${isSelected}>#${t.id} - ${t.name}</option>`;
                    }).join('');

                    return `
                      <div class="details-container">
                        ${linkHtml}
                        <h5>#${rawTask.id} - ${rawTask.name}</h5>
                        <p style="margin:0 0 5px 0; font-size:11px; color:#999;">${task._start.toLocaleDateString()} - ${task._end.toLocaleDateString()}</p>
                        
                        <label>Progress (%):</label>
                        <input ${disabledAttr} type="number" min="0" max="100" value="${rawTask.progress || 0}" onchange="updateGeneric(${rawTask.id}, 'progress', Number(this.value))">

                        
                        <label>Task Type:</label>
                        <select ${disabledAttr} onchange="updateGeneric(${rawTask.id}, 'task_type', this.value)">${typeOptions}</select>

                        <label>Assignee:</label>
                        <select ${disabledAttr} onchange="updateGeneric(${rawTask.id}, 'assignee', this.value)">${devOptions}</select>

                        <label>Task URL:</label>
                        <input ${disabledAttr} type="text" value="${rawTask.task_url || ''}" onchange="updateGeneric(${rawTask.id}, 'task_url', this.value)" placeholder="https://...">

                        <label>Dependencies:</label>
                        <select ${disabledAttr} multiple onchange="updateDependencies(${rawTask.id}, this)">
                            <option value="">(None)</option> ${depOptions}
                        </select>

                        <label>Description:</label>
                        <textarea ${disabledAttr} onchange="updateGeneric(${rawTask.id}, 'desc', this.value)">${rawTask.desc || ''}</textarea>
                      </div>
                    `;
                }
            });
        }

        function changeView(mode, btn) {
            document.querySelectorAll('.button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            gantt.change_view_mode(mode);
        }

        function lightenDarkenColor(col, amt) {
            let usePound = false; if (col[0] == "#") { col = col.slice(1); usePound = true; }
            let num = parseInt(col, 16);
            let r = (num >> 16) + amt; if (r > 255) r = 255; else if (r < 0) r = 0;
            let b = ((num >> 8) & 0x00FF) + amt; if (b > 255) b = 255; else if (b < 0) b = 0;
            let g = (num & 0x0000FF) + amt; if (g > 255) g = 255; else if (g < 0) g = 0;
            return (usePound ? "#" : "") + (g | (b << 8) | (r << 16)).toString(16);
        }

        function saveNewTask() {
            // Updated to grab all fields
            const id = document.getElementById('new-id').value; // Optional
            const name = document.getElementById('new-name').value;
            const start = document.getElementById('new-start').value;
            const end = document.getElementById('new-end').value;
            const type = document.getElementById('new-type').value;
            const assignee = document.getElementById('new-assignee').value;
            const progress = document.getElementById('new-progress').value;
            const url = document.getElementById('new-url').value;
            const desc = document.getElementById('new-desc').value;

            if (!name || !start || !end) return alert("Missing Mandatory Fields (Name, Start, End)");

            const payload = { 
                id, 
                name, 
                start, 
                end, 
                task_type: type, 
                assignee, 
                progress: Number(progress),
                task_url: url,
                desc: desc
            };

            fetch('/api/add-task', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
                .then(res => res.json())
                .then(data => { 
                    if(data.error) {
                        alert(data.error);
                    } else {
                        allTasks.push(data.task); 
                        redrawChart(); 
                        closeAddModal(); 
                        // Clear Inputs
                        document.getElementById('new-name').value = '';
                        document.getElementById('new-id').value = '';
                    }
                });
        }

        window.updateDependencies = function (id, selectElem) {
            const selectedValues = Array.from(selectElem.selectedOptions).map(opt => opt.value).filter(val => val !== "");
            updateGeneric(id, 'dependencies', selectedValues.join(', '));
        }

        window.updateGeneric = function (id, field, value) {
            updateServer({ id: id, [field]: value });
            const index = allTasks.findIndex(t => t.id == id);
            if (index > -1) allTasks[index][field] = value;
            redrawChart();
        }

        function updateServer(data) {
            fetch('/api/update-task', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).catch(console.error);
        }
    </script>
</body>

</html>